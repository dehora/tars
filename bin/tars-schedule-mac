#!/usr/bin/env bash
set -euo pipefail

HOUR=8
MINUTE=0
REMOVE=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --hour)
      HOUR="$2"; shift 2;;
    --minute)
      MINUTE="$2"; shift 2;;
    --remove)
      REMOVE=1; shift;;
    -h|--help)
      echo "usage: tars-schedule-mac [--hour H] [--minute M] [--remove]"; exit 0;;
    *)
      echo "unknown arg: $1"; exit 1;;
  esac
 done

if [[ -z "${TARS_HOME:-}" ]]; then
  echo "TARS_HOME is not set. Set it to the repo root." >&2
  exit 1
fi
REPO_DIR="$TARS_HOME"
PLIST="$HOME/Library/LaunchAgents/com.dehora.tars-email-brief.plist"
LOG_DIR="$HOME/Library/Logs"
STDOUT_LOG="$LOG_DIR/tars-email-brief.log"
STDERR_LOG="$LOG_DIR/tars-email-brief.err.log"

mkdir -p "$LOG_DIR"

if [[ "$REMOVE" -eq 1 ]]; then
  if [[ -f "$PLIST" ]]; then
    launchctl unload "$PLIST" >/dev/null 2>&1 || true
    rm -f "$PLIST"
    echo "removed $PLIST"
  else
    echo "no plist found at $PLIST"
  fi
  exit 0
fi

cat <<PLIST > "$PLIST"
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.dehora.tars-email-brief</string>
  <key>ProgramArguments</key>
  <array>
    <string>$REPO_DIR/bin/tars-email-brief</string>
  </array>
  <key>StartCalendarInterval</key>
  <dict>
    <key>Hour</key>
    <integer>$HOUR</integer>
    <key>Minute</key>
    <integer>$MINUTE</integer>
  </dict>
  <key>StandardOutPath</key>
  <string>$STDOUT_LOG</string>
  <key>StandardErrorPath</key>
  <string>$STDERR_LOG</string>
</dict>
</plist>
PLIST

launchctl unload "$PLIST" >/dev/null 2>&1 || true
launchctl load "$PLIST"

echo "installed launchd job: com.dehora.tars-email-brief at ${HOUR}:${MINUTE}"
