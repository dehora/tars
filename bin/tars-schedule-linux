#!/usr/bin/env bash
set -euo pipefail

HOUR=8
MINUTE=0
REMOVE=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --hour)
      HOUR="$2"; shift 2;;
    --minute)
      MINUTE="$2"; shift 2;;
    --remove)
      REMOVE=1; shift;;
    -h|--help)
      echo "usage: tars-schedule-linux [--hour H] [--minute M] [--remove]"; exit 0;;
    *)
      echo "unknown arg: $1"; exit 1;;
  esac
 done

if [[ -z "${TARS_HOME:-}" ]]; then
  echo "TARS_HOME is not set. Set it to the repo root." >&2
  exit 1
fi

UV_BIN="${TARS_UV:-}"
if [[ -z "$UV_BIN" ]]; then
  UV_BIN="$(command -v uv || true)"
fi
if [[ -z "$UV_BIN" ]]; then
  for candidate in "$HOME/.local/bin/uv" "$HOME/.cargo/bin/uv" "/usr/local/bin/uv" "/usr/bin/uv"; do
    if [[ -x "$candidate" ]]; then
      UV_BIN="$candidate"
      break
    fi
  done
fi
if [[ -z "$UV_BIN" ]]; then
  echo "uv not found. Install uv or set TARS_UV to its path." >&2
  exit 1
fi

CMD='echo "[tars-email-brief] $(date -Iseconds) start"; '"$UV_BIN"' run tars email-brief'

UNIT_DIR="$HOME/.config/systemd/user"
SERVICE="$UNIT_DIR/tars-email-brief.service"
TIMER="$UNIT_DIR/tars-email-brief.timer"

mkdir -p "$UNIT_DIR"

if [[ "$REMOVE" -eq 1 ]]; then
  systemctl --user disable --now tars-email-brief.timer >/dev/null 2>&1 || true
  rm -f "$SERVICE" "$TIMER"
  systemctl --user daemon-reload
  echo "removed systemd user units"
  exit 0
fi

cat <<SERVICE > "$SERVICE"
[Unit]
Description=tars email brief

[Service]
Type=oneshot
WorkingDirectory=$TARS_HOME
ExecStart=/bin/bash -lc '$CMD'
SERVICE

cat <<TIMER > "$TIMER"
[Unit]
Description=Run tars email brief daily

[Timer]
OnCalendar=*-*-* ${HOUR}:${MINUTE}:00
Persistent=true

[Install]
WantedBy=timers.target
TIMER

systemctl --user daemon-reload
systemctl --user enable --now tars-email-brief.timer

echo "installed systemd user timer at ${HOUR}:${MINUTE}"
